<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國語圈詞測驗卷生成器</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入 React 和 Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 字體設定 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Noto+Serif+TC:wght@400;700&display=swap');
        
        body { font-family: 'Noto Sans TC', sans-serif; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        
        /* 列印專用樣式 */
        @media print { 
            @page { 
                size: A4 portrait; 
                margin: 0;  /* 強制移除頁面邊距 */
            } 
            body { 
                background: white; 
                margin: 0;
                padding: 0;
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            
            /* 強制容器尺寸 */
            .print-container { 
                width: 210mm !important;
                height: 297mm !important;
                margin: 0 auto !important;
                box-shadow: none !important; 
                overflow: visible !important; /* 防止內容被切掉 */
                background-color: white !important;
            }

            /* 強制標題欄顯示 */
            .title-section {
                position: absolute !important;
                right: 0 !important;
                top: 0 !important;
                height: 100% !important;
                z-index: 1000 !important;
                background-color: white !important;
                visibility: visible !important;
            }
        }

        /* 隱藏捲軸但保留功能 */
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Icons ---
        const IconPrinter = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>;
        const IconType = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="4 7 4 4 20 4 20 7"></polyline><line x1="9" y1="20" x2="15" y2="20"></line><line x1="12" y1="4" x2="12" y2="20"></line></svg>;
        const IconEraser = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21"></path><path d="M22 21H7"></path><path d="m5 11 9 9"></path></svg>;
        const IconRefresh = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>;

        // --- 資料庫 ---
        const ZHUYIN_DB = {
          '竹': 'ㄓㄨˊ', '好': 'ㄏㄠˇ', '外': 'ㄨㄞˋ', '動': 'ㄉㄨㄥˋ',
          '美': 'ㄇㄟˇ', '不': 'ㄅㄨˋ', '一': 'ㄧ', '家': 'ㄐㄧㄚ',
          '人': 'ㄖㄣˊ', '艾': 'ㄞˋ', '叛': 'ㄆㄢˋ', '明': 'ㄇㄧㄥˊ',
          '天': 'ㄊㄧㄢ', '氣': 'ㄑㄧˋ', '真': 'ㄓㄣ', '空': 'ㄎㄨㄥ',
          '有': 'ㄧㄡˇ', '無': 'ㄨˊ', '大': 'ㄉㄚˋ', '小': 'ㄒㄧㄠˇ',
          '中': 'ㄓㄨㄥ', '文': 'ㄨㄣˊ', '字': 'ㄗˋ', '學': 'ㄒㄩㄝˊ',
          '校': 'ㄒㄧㄠˋ', '老': 'ㄌㄠˇ', '師': 'ㄕ', '生': 'ㄕㄥ',
          '日': 'ㄖˋ', '月': 'ㄩㄝˋ', '火': 'ㄏㄨㄛˇ', '水': 'ㄕㄨㄟˇ',
          '木': 'ㄇㄨˋ', '金': 'ㄐㄧㄣ', '土': 'ㄊㄨˇ', '爸': 'ㄅㄚˋ',
          '媽': 'ㄇㄚ', '哥': 'ㄍㄜ', '姐': 'ㄐㄧㄝˇ', '弟': 'ㄉㄧˋ',
          '妹': 'ㄇㄟˋ', '早': 'ㄗㄠˇ', '安': 'ㄢ', '謝': 'ㄒㄧㄝˋ',
          '花': 'ㄏㄨㄚ', '草': 'ㄘㄠˇ', '樹': 'ㄕㄨˋ', '林': 'ㄌㄧㄣˊ',
          '語': 'ㄩˇ', '詞': 'ㄘˊ', '練': 'ㄌㄧㄢˋ', '習': 'ㄒㄧˊ',
          '完': 'ㄨㄢˊ', '成': 'ㄔㄥˊ', '開': 'ㄎㄞ', '心': 'ㄒㄧㄣ'
        };

        const DEFAULT_WORDS = [
          "竹好", "外動", "美不一", "家人", "艾叛", "明日",
          "天氣", "真空", "有無", "大小", "中文", "文字",
          "學校", "老師", "學生", "生日", "日月", "金木"
        ];

        const parseZhuyin = (zhuyinStr) => {
          if (!zhuyinStr) return { symbols: '', tone: '' };
          const toneRegex = /[˙ˊˇˋ]/;
          const match = zhuyinStr.match(toneRegex);
          const tone = match ? match[0] : ''; 
          const symbols = zhuyinStr.replace(toneRegex, ''); 
          return { symbols, tone };
        };

        // --- App Component ---
        const App = () => {
          const [sheetTitle, setSheetTitle] = useState("國語圈詞練習單");
          const [inputLines, setInputLines] = useState(DEFAULT_WORDS.join('\n'));
          const [wordsData, setWordsData] = useState([]);
          const [fontSize, setFontSize] = useState(34);
          const [itemsPerRow, setItemsPerRow] = useState(6);
          const [showSettings, setShowSettings] = useState(true);

          useEffect(() => {
            const lines = inputLines.split('\n').filter(line => line.trim() !== '');
            
            setWordsData(prevData => {
              let newWordsData = [];
              lines.forEach((line, colIndex) => {
                const chars = line.split('');
                const colData = chars.map((char, charIndex) => {
                  const existingLine = prevData[colIndex];
                  const existingChar = existingLine && existingLine.chars[charIndex];
                  
                  let zhuyin = ZHUYIN_DB[char] || '';
                  let isCharHidden = false;
                  let isZhuyinHidden = false;

                  if (existingChar && existingChar.char === char) {
                    zhuyin = existingChar.zhuyin;
                    isCharHidden = existingChar.isCharHidden;
                    isZhuyinHidden = existingChar.isZhuyinHidden;
                  }

                  return {
                    id: `c-${colIndex}-${charIndex}`,
                    char,
                    zhuyin,
                    isCharHidden,
                    isZhuyinHidden
                  };
                });

                newWordsData.push({
                  id: `line-${colIndex}`,
                  chars: colData
                });
              });
              return newWordsData;
            });
          }, [inputLines]);

          const handlePrint = () => window.print();

          const setGlobalMode = (mode) => {
            setWordsData(prev => prev.map(line => ({
              ...line,
              chars: line.chars.map(c => ({
                ...c,
                isCharHidden: mode === 'hideChar',
                isZhuyinHidden: mode === 'hideZhuyin'
              }))
            })));
          };

          const toggleCharHide = (lineIndex, charIndex) => {
            setWordsData(prev => {
              const newData = [...prev];
              newData[lineIndex].chars[charIndex].isCharHidden = !newData[lineIndex].chars[charIndex].isCharHidden;
              return newData;
            });
          };

          const toggleZhuyinHide = (lineIndex, charIndex) => {
            setWordsData(prev => {
              const newData = [...prev];
              newData[lineIndex].chars[charIndex].isZhuyinHidden = !newData[lineIndex].chars[charIndex].isZhuyinHidden;
              return newData;
            });
          };

          const updateZhuyin = (lineIndex, charIndex, newZhuyin) => {
            setWordsData(prev => {
              const newData = [...prev];
              newData[lineIndex].chars[charIndex].zhuyin = newZhuyin;
              newData[lineIndex].chars[charIndex].isZhuyinHidden = false;
              return newData;
            });
          };

          // 自動分列邏輯
          const section1 = wordsData.slice(0, itemsPerRow);
          const section2 = wordsData.slice(itemsPerRow, itemsPerRow * 2);
          const section3 = wordsData.slice(itemsPerRow * 2, itemsPerRow * 3);

          return (
            <div className="min-h-screen flex flex-col md:flex-row">
              
              {/* 預覽區 */}
              <div className="flex-1 p-4 md:p-8 overflow-auto flex justify-center bg-gray-100 print:bg-white print:p-0">
                <div 
                  className="bg-white shadow-lg relative box-border flex overflow-hidden print-container"
                  style={{
                    width: '210mm',
                    height: '297mm',
                    padding: '10mm',
                    position: 'relative' // 為了絕對定位
                  }}
                >
                  {/* 右側標題區 (使用絕對定位固定在右側) */}
                  {/* 在 print 時，這個 class 'title-section' 會強制覆寫樣式 */}
                  <div 
                    className="title-section border-l-2 border-black flex flex-col items-center pt-8 flex-shrink-0 bg-white"
                    style={{ 
                        position: 'absolute',
                        right: '10mm', // 對應 A4 padding
                        top: '10mm',
                        bottom: '10mm',
                        width: '90px',
                        writingMode: 'vertical-rl',
                        zIndex: 50
                    }}
                  >
                    <h1 className="text-3xl font-bold tracking-[0.2em] font-serif mb-12 text-center whitespace-nowrap">{sheetTitle}</h1>
                    
                    <div className="flex gap-4 text-base font-medium tracking-widest justify-center w-full">
                       <div className="flex items-center pt-4 gap-2"><span>班級</span><span className="border-l border-black h-20 block"></span></div>
                       <div className="flex items-center pt-4 gap-2"><span>座號</span><span className="border-l border-black h-16 block"></span></div>
                       <div className="flex items-center pt-4 gap-2"><span>姓名</span><span className="border-l border-black h-24 block"></span></div>
                       <div className="flex items-center pt-4 gap-2"><span>得分</span><span className="border-l border-black h-16 block"></span></div>
                    </div>
                    
                    <div className="mt-auto mb-4 text-xs text-gray-400 tracking-widest no-print">國語圈詞練習</div>
                  </div>

                  {/* 左側題目區 (主內容) */}
                  <div 
                    className="flex-1 flex flex-col h-full"
                    style={{
                        marginRight: '100px' // 預留空間給絕對定位的標題
                    }}
                  >
                    {/* 上段 */}
                    <div className="flex-1 border-b-2 border-dashed border-gray-300 flex items-start justify-end">
                       <div className="w-full h-full flex flex-row-reverse flex-wrap content-start items-start gap-y-4 px-2 pt-4">
                          {section1.map((line, idx) => (
                            <QuestionItem 
                              key={line.id} line={line} index={idx} fontSize={fontSize}
                              onToggleChar={(cIdx) => toggleCharHide(idx, cIdx)}
                              onToggleZhuyin={(cIdx) => toggleZhuyinHide(idx, cIdx)}
                              onUpdateZhuyin={(cIdx, val) => updateZhuyin(idx, cIdx, val)}
                            />
                          ))}
                       </div>
                    </div>

                    {/* 中段 */}
                    <div className="flex-1 border-b-2 border-dashed border-gray-300 flex items-start justify-end">
                       <div className="w-full h-full flex flex-row-reverse flex-wrap content-start items-start gap-y-4 px-2 pt-4">
                          {section2.map((line, idx) => {
                            const realIdx = idx + itemsPerRow;
                            return (
                              <QuestionItem 
                                key={line.id} line={line} index={realIdx} fontSize={fontSize}
                                onToggleChar={(cIdx) => toggleCharHide(realIdx, cIdx)}
                                onToggleZhuyin={(cIdx) => toggleZhuyinHide(realIdx, cIdx)}
                                onUpdateZhuyin={(cIdx, val) => updateZhuyin(realIdx, cIdx, val)}
                              />
                            );
                          })}
                       </div>
                    </div>

                    {/* 下段 */}
                    <div className="flex-1 flex items-start justify-end">
                       <div className="w-full h-full flex flex-row-reverse flex-wrap content-start items-start gap-y-4 px-2 pt-4">
                          {section3.map((line, idx) => {
                            const realIdx = idx + itemsPerRow * 2;
                            return (
                              <QuestionItem 
                                key={line.id} line={line} index={realIdx} fontSize={fontSize}
                                onToggleChar={(cIdx) => toggleCharHide(realIdx, cIdx)}
                                onToggleZhuyin={(cIdx) => toggleZhuyinHide(realIdx, cIdx)}
                                onUpdateZhuyin={(cIdx, val) => updateZhuyin(realIdx, cIdx, val)}
                              />
                            );
                          })}
                       </div>
                    </div>
                  </div>

                </div>
              </div>

              {/* 設定面板 (no-print) */}
              <div className={`
                bg-slate-900 text-white w-full md:w-80 flex-shrink-0 p-5 flex flex-col gap-4 no-print
                transition-all duration-300 z-20 overflow-y-auto h-screen md:h-auto
                ${!showSettings ? 'hidden' : ''}
              `}>
                 <div className="flex items-center justify-between border-b border-slate-700 pb-3">
                  <h2 className="text-lg font-bold flex items-center gap-2">
                    <IconSettings /> 出題設定
                  </h2>
                </div>
                
                <div className="bg-slate-800 p-3 rounded text-sm space-y-2 border border-slate-700">
                     <p className="text-green-400 font-bold">✅ 已優化列印</p>
                     <p className="text-xs text-slate-300">若仍未看到標題，請在列印設定中勾選「背景圖形」。</p>
                </div>

                <div className="space-y-1 flex-1 flex flex-col min-h-[150px]">
                  <label className="text-sm text-slate-400">輸入詞彙</label>
                  <textarea
                    className="w-full flex-1 bg-slate-800 border-slate-700 border rounded p-2 text-white outline-none font-mono text-lg tracking-wider resize-none"
                    value={inputLines}
                    onChange={(e) => setInputLines(e.target.value)}
                  />
                </div>

                <div className="space-y-1">
                  <label className="text-sm text-slate-400">標題</label>
                  <input type="text" value={sheetTitle} onChange={(e) => setSheetTitle(e.target.value)} className="w-full bg-slate-800 border-slate-700 border rounded p-2 text-white outline-none" />
                </div>

                <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-1">
                        <div className="flex justify-between text-xs text-slate-400"><span>字體</span><span>{fontSize}</span></div>
                        <input type="range" min="24" max="48" step="2" value={fontSize} onChange={(e) => setFontSize(parseInt(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg accent-blue-500" />
                    </div>
                    <div className="space-y-1">
                        <div className="flex justify-between text-xs text-slate-400"><span>每列題數</span><span>{itemsPerRow}</span></div>
                        <input type="range" min="4" max="8" step="1" value={itemsPerRow} onChange={(e) => setItemsPerRow(parseInt(e.target.value))} className="w-full h-2 bg-slate-700 rounded-lg accent-blue-500" />
                    </div>
                </div>

                <div className="grid grid-cols-2 gap-2 pt-2">
                  <button onClick={() => setGlobalMode('hideZhuyin')} className="bg-slate-800 hover:bg-blue-600 p-2 rounded text-sm flex items-center justify-center gap-1 border border-slate-700"><IconEraser /> 挖空注音</button>
                  <button onClick={() => setGlobalMode('hideChar')} className="bg-slate-800 hover:bg-blue-600 p-2 rounded text-sm flex items-center justify-center gap-1 border border-slate-700"><IconType /> 挖空國字</button>
                  <button onClick={() => setGlobalMode('normal')} className="col-span-2 bg-slate-800 hover:bg-green-600 p-2 rounded text-sm flex items-center justify-center gap-1 border border-slate-700"><IconRefresh /> 全部顯示</button>
                </div>
                
                <button onClick={handlePrint} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow flex items-center justify-center gap-2 mb-8 md:mb-0"><IconPrinter /> 列印 / PDF</button>
              </div>
              
              <button className="fixed bottom-4 right-4 bg-slate-900 text-white p-3 rounded-full shadow-lg md:hidden no-print z-30" onClick={() => setShowSettings(!showSettings)}><IconSettings /></button>

            </div>
          );
        };

        const QuestionItem = ({ line, index, fontSize, onToggleChar, onToggleZhuyin, onUpdateZhuyin }) => {
            return (
                <div 
                    className="flex flex-col items-center gap-2 px-2"
                    style={{ flex: '0 0 auto', minWidth: '14%' }}
                >
                    <div className="w-6 h-6 rounded-full border border-black flex items-center justify-center text-xs font-mono font-bold mb-1">
                        {index + 1}
                    </div>
                    <div className="flex flex-col items-center gap-1">
                        {line.chars.map((charData, cIdx) => (
                            <WordBlock 
                                key={charData.id}
                                data={charData}
                                fontSize={fontSize}
                                onToggleChar={() => onToggleChar(cIdx)}
                                onToggleZhuyin={() => onToggleZhuyin(cIdx)}
                                onUpdateZhuyin={(val) => onUpdateZhuyin(cIdx, val)}
                            />
                        ))}
                    </div>
                </div>
            )
        }

        const ZhuyinDisplay = ({ zhuyinStr, isHidden, fontSize }) => {
          const { symbols, tone } = parseZhuyin(zhuyinStr);
          const isNeutralTone = tone === '˙';
          
          return (
            <div className={`relative flex flex-col items-center justify-center h-full w-full ${isHidden ? 'invisible' : 'visible'}`}>
              {isNeutralTone && (
                <span className="absolute -top-[0.4em] left-1/2 -translate-x-1/2 font-bold scale-75">˙</span>
              )}
              <div className="flex flex-col items-center leading-none justify-center h-full">
                {symbols.split('').map((s, i) => (
                  <span key={i} className="transform scale-y-110 block" style={{ height: '0.9em' }}>{s}</span>
                ))}
              </div>
              {!isNeutralTone && tone && (
                <span className="absolute -right-[0.5em] top-1/2 -translate-y-1/2 font-bold scale-90">{tone}</span>
              )}
            </div>
          );
        };

        const WordBlock = ({ data, fontSize, onToggleChar, onToggleZhuyin, onUpdateZhuyin }) => {
          const [isEditing, setIsEditing] = useState(false);
          const [tempZhuyin, setTempZhuyin] = useState(data.zhuyin);
          const inputRef = useRef(null);

          const handleZhuyinClick = (e) => { e.stopPropagation(); onToggleZhuyin(); };
          const handleZhuyinDoubleClick = (e) => { e.stopPropagation(); setTempZhuyin(data.zhuyin); setIsEditing(true); setTimeout(() => inputRef.current?.focus(), 10); };
          const handleBlur = () => { setIsEditing(false); onUpdateZhuyin(tempZhuyin); };
          const handleKeyDown = (e) => { if (e.key === 'Enter') handleBlur(); };

          return (
            <div 
                className="flex border border-transparent"
                style={{ 
                    fontSize: `${fontSize}px`,
                    width: `${fontSize * 1.5}px`, 
                    height: `${fontSize * 1.4}px`, 
                }}
            >
                <div 
                    onClick={onToggleChar}
                    className={`
                        flex justify-center items-center border border-black cursor-pointer hover:bg-gray-50 transition-colors
                        ${data.isCharHidden ? 'text-transparent' : 'text-black'}
                    `}
                    style={{ flex: 1, lineHeight: 1 }}
                >
                    {data.char}
                </div>
                <div 
                    className={`
                        flex justify-center items-center select-none cursor-pointer hover:bg-blue-50 transition-colors relative
                        ${data.isZhuyinHidden ? 'border border-gray-400 rounded-sm' : ''}
                    `}
                    style={{ width: '35%', fontSize: '0.4em' }}
                    onClick={handleZhuyinClick}
                    onDoubleClick={handleZhuyinDoubleClick}
                >
                    {isEditing ? (
                        <input 
                            ref={inputRef}
                            value={tempZhuyin}
                            onChange={(e) => setTempZhuyin(e.target.value)}
                            onBlur={handleBlur}
                            onKeyDown={handleKeyDown}
                            className="w-full h-full text-center bg-yellow-100 outline-none p-0 m-0 border-none absolute top-0 left-0"
                            style={{ fontSize: '12px' }}
                            onClick={(e) => e.stopPropagation()} 
                        />
                    ) : (
                        <ZhuyinDisplay zhuyinStr={data.zhuyin} isHidden={data.isZhuyinHidden} fontSize={fontSize} />
                    )}
                </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>